<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${ricetta.titolo}">Dettaglio Ricetta</title>
    
    <link rel="stylesheet" th:href="@{/css/stile.css}" />
    <link rel="stylesheet" th:href="@{/css/ricetta.css}" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="magic-background-layer"></div>

    <header class="main-header">
        <div class="header-content-wrapper">
            <div class="header-left">
                <a th:href="@{/}" class="btn-gold">
                    <i class="fa-solid fa-house-chimney"></i> Home
                </a>
                
                <div sec:authorize="hasAuthority('ADMIN')">
                    <a th:href="@{/admin/indiceAdmin}" class="btn-gold">
                        <i class="fa-solid fa-crown"></i> Gestione Admin
                    </a>
                </div>
                
                <div sec:authorize="hasAuthority('DEFAULT')">
                    <a th:href="@{/manageProfilo}" class="btn-gold">
                        <i class="fa-solid fa-user-gear"></i> Gestione Profilo
                    </a>
                </div>
            </div>
            
            <div class="header-right">
                 <div sec:authorize="isAuthenticated()" style="display:flex; align-items:center; gap:10px;">
					<div th:if="${currentUser != null}" style="display: inline-block;">
					    <span th:if="${currentUser.credentials != null && currentUser.credentials.ruolo == 'ADMIN'}" 
					          class="chef-name" 
					          style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 8px;">
					           <i class="fa-solid fa-crown" style="color: #C5A059;"></i>
					           <span th:text="${currentUser.nome} + ' ' + ${currentUser.cognome}">Admin</span>
					    </span>

					    <span th:if="${currentUser.credentials != null && currentUser.credentials.ruolo == 'DEFAULT'}" class="header-text">
					        <i class="fa-solid fa-user"></i>
					        <span th:text="|${currentUser.nome} ${currentUser.cognome}|">Nome Cognome</span>
					    </span>
					</div>
                    
                    <form th:action="@{/logout}" method="post" style="margin: 0;">
                        <button type="submit" class="btn-logout">
                            Logout <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </form>
                </div>
                
                <div sec:authorize="!isAuthenticated()" class="guest-actions" style="display:flex; align-items:center; gap:10px;">
                    <span class="welcome-text">Benvenuto!</span>
                    <a th:href="@{/login}" class="btn-gold">Accedi</a>
                    <a th:href="@{/registrazione}" class="btn-gold">Registrati</a>
                </div>
            </div>
        </div>
    </header>

    <main class="single-recipe-card">
        <div class="title-section">
            <h1 th:text="${ricetta.titolo}">Titolo Ricetta</h1>
            
            <div class="meta-info-row">
                <span>
                    <i class="fas fa-user-edit"></i>
                    <span th:if="${ricetta.autore != null}" th:text="${ricetta.autore.nome} + ' ' + ${ricetta.autore.cognome}">Chef</span>
                    <span th:unless="${ricetta.autore != null}">Anonimo</span>
                </span>
                <span th:if="${ricetta.dataInserimento}">|</span>
                <span th:if="${ricetta.dataInserimento}">
                    <i class="far fa-calendar-alt"></i> 
                    <span th:text="${#temporals.format(ricetta.dataInserimento, 'dd MMMM yyyy')}">Data</span>
                </span>
            </div>
            <p class="subtitle" th:text="${ricetta.descrizione}">Descrizione breve...</p>
        </div>

        <div class="content-grid">
            <div class="left-column">
                <div class="ingredients-header-container">
                    <h2 class="ingredients-header">Ingredienti</h2>
                </div>
                
                <ul class="ingredients-list">
                    <li th:each="riga : ${ricetta.ricettaIngredienti}">
                        <i class="fas fa-star star-icon"></i> 
                        <span th:text="${riga.quantita > 0} ? ${riga.quantita} + ' ' + ${riga.unita} : ${riga.unita}">200 g</span>
                        <span> di </span>
                        <strong th:text="${riga.ingrediente.nome}" class="ingredient-name">Farina</strong>
                    </li>
                    
                    <li th:if="${#lists.isEmpty(ricetta.ricettaIngredienti)}" style="font-style: italic; color: #666;">
                        Nessun ingrediente specificato.
                    </li>
                </ul>
                
                <div class="procedure-text">
                    <h3><i class="fas fa-scroll"></i> Procedimento</h3>
                    <p th:text="${ricetta.procedimento}">Qui ci sarà il procedimento...</p>
                </div>
            </div>

            <div class="right-column">
                <div class="recipe-image-wrapper">
                    <img th:if="${ricetta.imageUrl != null}" th:src="${ricetta.imageUrl}" alt="Immagine Ricetta"/>
                    <img th:unless="${ricetta.imageUrl != null}" src="/images/placeholder-piatto.jpg" alt="Nessuna immagine"/>
                </div>
                
                <div class="tech-details">
                    <h3><i class="fas fa-info-circle"></i> Dettagli</h3>
                    <ul class="tech-list">
                        
                        <li>
                            <span><i class="fas fa-tag"></i> Categoria:</span>
                            <strong th:text="${ricetta.categoria} != null ? ${ricetta.categoria} : '-'">Dolci</strong>
                        </li>
						
						<li>
						            <span><i class="fas fa-leaf"></i> Dieta:</span>
						            <strong th:if="${ricetta.tags != null && !ricetta.tags.isEmpty()}" 
						                    th:text="${#strings.listJoin(ricetta.tags, ', ')}">Vegetariano, Vegano</strong>
						            <strong th:if="${ricetta.tags == null || ricetta.tags.isEmpty()}">-</strong>
						        </li>

                        <li>
                            <span><i class="fas fa-clock"></i> Preparazione:</span>
                            <strong th:text="${ricetta.tempoDiPreparazione} + ' min'">30 min</strong>
                        </li>

                        <li>
                            <span><i class="fas fa-fire"></i> Cottura:</span>
                            <strong th:text="${ricetta.tempoDiCottura} != null ? ${ricetta.tempoDiCottura} + ' min' : '-'">20 min</strong>
                        </li>

                        <li>
                            <span><i class="fas fa-signal"></i> Difficoltà:</span>
                            <strong th:text="${ricetta.difficolta}">Media</strong>
                        </li>

                        <li>
                            <span><i class="fas fa-utensils"></i> Porzioni:</span>
                            <strong th:text="${ricetta.porzioni} != null ? ${ricetta.porzioni} : '-'">4</strong>
                        </li>
                    </ul>
                </div>
				
				<div class="recipe-tips" th:if="${ricetta.note != null}">
				    <h3><i class="fas fa-lightbulb"></i> Consigli </h3>
				    <p th:text="${ricetta.note}">
				        Per un risultato perfetto, assicuratevi che tutti gli ingredienti siano a temperatura ambiente prima di iniziare.
				    </p>
				</div>
            </div>
        </div>

        <div class="reviews-section">
    <h2 class="reviews-title"><i class="fas fa-comments"></i> I Commenti</h2>

    <div th:if="${!ricetta.recensioni.empty}">
        <div th:each="recensione : ${ricetta.recensioni}" class="review-card">
            
            <div th:if="${recensioneDaModificare != null && recensioneDaModificare.id == recensione.id}">
                <h3 class="edit-inline-title">Modifica la tua recensione</h3>
                
                <form th:action="@{'/recensione/modifica/' + ${recensione.id}}" 
                      method="POST" 
                      th:object="${recensioneDaModificare}" 
                      class="form-magic">
                    
                    <div class="row">
                        <div class="form-row-title">
                            <input type="text" th:field="*{titolo}" required />
                        </div>
                        <div class="form-row-rating">
                            <select th:field="*{voto}" required>
                                <option value="5">5 ★★★★★</option>
                                <option value="4">4 ★★★★</option>
                                <option value="3">3 ★★★</option>
                                <option value="2">2 ★★</option>
                                <option value="1">1 ★</option>
                            </select>
                        </div>
                    </div>
                    
                    <textarea th:field="*{testo}" rows="3" required></textarea>
                    
                    <div class="edit-actions-container" style="margin-top: 10px;">
                        <button type="submit" class="btn-gold">Salva Modifiche</button>
                        <a th:href="@{'/ricetta/' + ${ricetta.id}}" class="btn-logout" style="min-width: auto;">Annulla</a>
                    </div>
                </form>
            </div>

            <div th:unless="${recensioneDaModificare != null && recensioneDaModificare.id == recensione.id}">
                
				<div class="review-header" style="display: flex; justify-content: space-between; align-items: center;">
				    <span>
				        <i class="fas fa-user"></i> 
				        <span th:text="${recensione.autore.nome}">Nome</span>
				    </span>

				    <span th:if="${recensione.dataInserimento != null}" style="color: #888; font-size: 0.8rem; font-style: italic;">
				        <i class="far fa-calendar-alt"></i> 
				        <span th:text="${#temporals.format(recensione.dataInserimento, 'dd/MM/yyyy')}">10/02/2026</span>
				    </span>
				</div>

				<div class="review-stars" style="margin-bottom: 5px;">
				    <i class="fas fa-star" th:each="i : ${#numbers.sequence(1, recensione.voto)}"></i>
				</div>			
				
                
                <strong th:text="${recensione.titolo}" class="review-title-text">Titolo</strong>
                <p th:text="${recensione.testo}" class="review-body-text">Testo...</p>

                <div class="review-actions" 
                    th:if="${currentUser != null} and (${recensione.autore.id} == ${currentUser.id} or ${currentUser.credentials.ruolo == 'ADMIN'})">
                     
                     <a th:if="${recensione.autore.id} == ${currentUser.id}"
                        th:href="@{'/recensione/modifica/' + ${recensione.id}}" 
                        class="btn-gold" 
                        style="min-width: 100px; height: 36px; font-size: 0.75rem; display: inline-flex; align-items: center; justify-content: center; text-decoration: none;">
                        <i class="fas fa-edit"></i>&nbsp;Modifica
                     </a>

                     <form th:action="@{'/ricetta/' + ${ricetta.id} + '/recensione/' + ${recensione.id} + '/delete'}" 
                           method="POST" 
                           style="display:inline;">
                         
                         <button type="submit" 
                                 onclick="return confirm('Cancellare questa recensione?');"
                                 class="btn-logout" 
                                 style="min-width: 100px; height: 36px; font-size: 0.75rem; cursor: pointer;">
                             <i class="fas fa-trash"></i> Cancella
                         </button>
                     </form>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${ricetta.recensioni.empty}" class="empty-reviews-msg">
        <p>Nessuna recensione presente. Sii il primo a commentare!</p>
    </div>

    <div sec:authorize="isAuthenticated()" th:if="${recensioneDaModificare == null}" class="new-review-box">
        <h3>Lascia la tua opinione</h3>
        <form th:action="@{'/ricetta/' + ${ricetta.id} + '/recensione'}" method="POST" th:object="${nuovaRecensione}" class="form-magic">
            
            <div th:if="${#fields.hasGlobalErrors()}" class="error-global">
                <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
            </div>
            
            <div class="row">
                <div class="form-row-title">
                    <input type="text" th:field="*{titolo}" placeholder="Titolo della recensione..." required />
                </div>
                <div class="form-row-rating">
                    <select th:field="*{voto}" required>
                        <option value="5">5 ★★★★★</option>
                        <option value="4">4 ★★★★</option>
                        <option value="3">3 ★★★</option>
                        <option value="2">2 ★★</option>
                        <option value="1">1 ★</option>
                    </select>
                </div>
            </div>
            <span th:if="${#fields.hasErrors('titolo')}" th:errors="*{titolo}" class="error-field"></span>
            
            <textarea th:field="*{testo}" rows="3" placeholder="Raccontaci la tua esperienza..." required></textarea>
            <span th:if="${#fields.hasErrors('testo')}" th:errors="*{testo}" class="error-field"></span>

            <div class="form-magic" style="display:flex; justify-content:center;">
                <button type="submit" class="btn-gold">
                    <i class="fas fa-feather-pointed"></i> Pubblica Recensione
                </button>
            </div>
        </form>
    </div>

    <div sec:authorize="!isAuthenticated()" class="guest-msg-container">
        <p><em><a href="/login" class="link-accedi-gold">Accedi</a> per lasciare una recensione.</em></p>
    </div>
</div>
       
        <div class="admin-actions-centered" 
             th:if="${currentUser != null} and (${ricetta.autore.id} == ${currentUser.id} or ${#authorization.expression('hasAuthority(''ADMIN'')')})">
         <a th:href="@{/ricetta/{id}/edit(id=${ricetta.id})}" class="btn-gold">
                <i class="fas fa-pencil-alt"></i> Modifica
            </a>
            <form th:action="@{'/ricetta/delete/' + ${ricetta.id}}" method="POST" class="delete-form-inline">
                <button type="submit" class="btn-logout"
                        onclick="return confirm('Sei sicuro di voler eliminare questa ricetta?');">
                    <i class="fas fa-trash-alt"></i> Elimina
                </button>
            </form>
        </div>
    </main>
</body>
</html>