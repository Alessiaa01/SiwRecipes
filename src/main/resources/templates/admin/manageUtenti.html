<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Utenti - Disney Admin</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" th:href="@{/css/stile.css}" />
    <link rel="stylesheet" th:href="@{/css/manageUtenti.css}" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

   <header>
    <div class="header-content-wrapper">
        
        <div class="header-left">
            <div class="btn-gold">
                <a th:href="@{/}">
                    <i class="fa-solid fa-house-chimney"></i> Home
                </a>
            </div>

            <div sec:authorize="hasAuthority('ADMIN')" class="btn-gold">
                <a th:href="@{/admin/indiceAdmin}">
                    <i class="fa-solid fa-crown"></i> Gestione Admin
                </a>
            </div>
        </div>

        <div class="user-actions-right">
            <div th:if="${currentUser != null}" style="display: inline-block;">
                
                <span th:if="${currentUser.credentials?.ruolo == 'ADMIN'}" 
                      class="chef-name" 
                      style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 8px;">
                       <i class="fa-solid fa-crown" style="color: #C5A059;"></i>
                       <span th:text="${currentUser.nome} + ' ' + ${currentUser.cognome}">Admin</span>
                </span>

                <span th:unless="${currentUser.credentials?.ruolo == 'ADMIN'}" class="header-text">
                    <i class="fa-solid fa-user"></i>
                    <span th:text="|${currentUser.nome} ${currentUser.cognome}|">Nome Cognome</span>
                </span>
            </div>

            <form th:action="@{/logout}" method="post" style="margin:0;">
                <button type="submit" class="btn-logout">
                    Logout <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </form>
        </div>

    </div>
</header>

    <div class="hero-section">
		<div class="logo-container">
		           <a th:href="@{/}">
		               <img src="/images/logo2 copia.png" class="main-logo" alt="SiwRecipe Logo" onerror="this.style.display='none'"/>
		           </a>  
		       </div>
        <h1 class="main-title">Registro degli Utenti</h1>
    </div>

    <div class="container user-container" style="padding-bottom: 50px;">
        <div class="parchment-panel">
           
            <div class="table-responsive">
                <table class="magic-table">
                    <thead>
                        <tr>
                            <th>Utente</th>
                            <th>Contatti</th>
                            <th>Ruolo</th>
                            <th>Stato</th>
                            <th class="text-right">Azioni Reali</th>
                        </tr>
                    </thead>
                    
                    <tbody>
                        <tr th:each="cred : ${credentialsList}" 
                            th:classappend="${!cred.enabled} ? 'row-banned' : ''">
                            
                            <td>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <div style="background:#fff; border-radius:50%; padding:8px; border:1px solid #e0d4b8;">
                                        <i class="fa-solid fa-user" style="color:#C5A059;"></i>
                                    </div>
                                    
                                    <div style="display:flex; flex-direction:column; text-align:left;">
                                        <span class="font-title" th:text="${cred.username}"
                                              th:style="${!cred.enabled} ? 'text-decoration: line-through; color: #999;' : ''">
                                            MarioRossi
                                        </span>
                                        
                                        <span class="sub-text" th:if="${cred.utente != null}" 
                                              th:text="|${cred.utente.nome} ${cred.utente.cognome}|">
                                            Mario Rossi
                                        </span>
                                    </div>
                                </div>
                            </td>
                            
                            <td th:text="${cred.utente != null ? cred.utente.email : 'N/A'}" style="font-style: italic; color:#666;">
                                email@example.com
                            </td>
                            
                            <td>
                                <span class="role-badge" 
                                      th:classappend="${cred.ruolo == 'ADMIN'} ? 'badge-admin' : 'badge-user'">
                                    <i th:class="${cred.ruolo == 'ADMIN'} ? 'fa-solid fa-crown' : 'fa-solid fa-user'"></i>
                                    <span th:text="${cred.ruolo}">USER</span>
                                </span>
                            </td>

                            <td>
                                <span th:if="${cred.enabled}" class="status-badge badge-active">
                                    <i class="fas fa-check-circle"></i> Attivo
                                </span>
                                <span th:if="${!cred.enabled}" class="badge-banned" 
                                      style="padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 5px;">
                                    <i class="fas fa-user-slash"></i> Bloccato
                                </span>
                            </td>
                            
                            <td class="text-right">
                                <div class="action-buttons" style="display: flex; justify-content: flex-end; gap: 10px;">
                                    
                                    <div th:if="${cred.username != #authentication.name}" style="display: flex; gap: 10px;">
                                        
                                        <form th:if="${cred.enabled}" 
                                              th:action="@{/admin/manageUtenti/{username}/ban(username=${cred.username})}" 
                                              method="post" style="margin:0;">
                                            <button type="submit" class="btn-magic btn-ban-magic" 
                                                    onclick="return confirm('Sei sicuro di voler esiliare questo utente dal regno?');">
                                                <i class="fas fa-gavel"></i>
                                                <span>Blocca</span>
                                            </button>
                                        </form>

                                        <form th:if="${!cred.enabled}" 
                                              th:action="@{/admin/manageUtenti/{username}/unban(username=${cred.username})}" 
                                              method="post" style="margin:0;">
                                            <button type="submit" class="btn-magic btn-unban-magic" 
                                                    onclick="return confirm('Vuoi riammettere questo utente nel regno?');">
                                                <i class="fas fa-key"></i>
                                                <span>Sblocca</span>
                                            </button>
                                        </form>

                                    </div>

                                    <span th:if="${cred.username == #authentication.name}" 
                                          style="font-family: var(--font-ui); font-weight:bold; color:#C5A059;">
                                        <i class="fas fa-crown"></i> (Tu)
                                    </span>
                                </div>
                            </td>
                        </tr>
                        
                        <tr th:if="${credentialsList == null or credentialsList.empty}">
                            <td colspan="5" style="padding: 40px; text-align: center; color: #888;">
                                <i class="fas fa-wind" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                                Nessun utente trovato.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</body>
</html>